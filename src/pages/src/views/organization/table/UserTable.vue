<!--
  - TencentBlueKing is pleased to support the open source community by making 蓝鲸智云-用户管理(Bk-User) available.
  - Copyright (C) 2017-2021 THL A29 Limited, a Tencent company. All rights reserved.
  - Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License.
  - You may obtain a copy of the License at http://opensource.org/licenses/MIT
  - Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
  - an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
  - specific language governing permissions and limitations under the License.
  -->
<template>
  <div class="table-list-wrapper">
    <div class="thead-container table-container" data-test-id="list_activeTableHeardData">
      <table>
        <thead>
          <tr v-if="userMessage.tableHeardList.length">
            <th v-if="currentCategoryType === 'local' && noSearchOrSearchDepartment" class="checkbox-table-item">
              <label class="king-checkbox king-checkbox-small" @click.stop="selectAll">
                <input type="checkbox" name="checkbox1" :checked="isAllChecked">
              </label>
            </th>
            <th v-for="(heardItem, heardIndex) in activeTableHeardList" :key="heardIndex">
              <span>{{heardItem.name}}</span>
            </th>
          </tr>
        </thead>
      </table>
    </div>
    <div
      class="tbody-container table-container" ref="scrollWrapper"
      @scroll.passive="handleTableScroll" data-test-id="list_organizationData">
      <table v-if="userMessage.userInforList.length">
        <tbody>
          <tr v-for="(item, index) in dataList" :key="item.id + Date.now()" @click.stop="viewDetails(item)">
            <td v-if="currentCategoryType === 'local' && noSearchOrSearchDepartment" class="checkbox-table-item">
              <label class="king-checkbox king-checkbox-small" @click.stop="selectItemInfor(item)">
                <input type="checkbox" name="checkbox1" :checked="item.isCheck">
              </label>
            </td>
            <td
              :class="{ 'hidden': labelName.indexOf(key) !== -1 }"
              v-for="(key, keyIndex) in Object.keys(item)"
              :key="keyIndex">
              <!-- 组织 -->
              <div v-if="key === 'department_name'" class="king-tooltips">
                <span
                  class="staff-text" v-bk-tooltips="{
                    allowHtml: true,
                    content: '#' + key + keyIndex + index,
                    distance: 12,
                    theme: 'light',
                    placement: 'bottom-start'
                  }">{{departmentShift(item[key])}}</span>
                <div :id="key + keyIndex + index">
                  <div v-for="(deItem, deIndex) in item[key]" :key="deIndex">
                    {{deItem}}
                  </div>
                </div>
              </div>
              <!-- 上级 -->
              <div class="list-wrapper" v-else-if="key === 'leader'">
                <span v-bk-overflow-tips>{{getLeaderString(item[key]) || '--'}}</span>
              </div>
              <!-- 其他字段 -->
              <div class="list-wrapper" v-else>
                <span v-bk-overflow-tips>{{getValueByType(key, item[key]) || '--'}}</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <EmptyComponent
        v-else
        :is-data-empty="isTableDataEmpty"
        :is-search-empty="isEmptySearch"
        :is-data-error="isTableDataError"
        @handleEmpty="$emit('handleClickEmpty')"
        @handleUpdate="$emit('handleRefresh')" />
    </div>
  </div>
</template>

<script>
import { dateConvert } from '@/common/util';
import EmptyComponent from '@/components/empty';
export default {
  components: { EmptyComponent },
  props: {
    fieldsList: {
      type: Array,
      required: true,
    },
    userMessage: {
      type: Object,
      default: {},
    },
    isEmptySearch: {
      type: Boolean,
      default: false,
    },
    // 控制设置所在组织、批量删除的显示
    isClick: {
      type: Boolean,
      default: false,
    },
    loading: {
      type: Boolean,
      default: true,
    },
    currentCategoryType: {
      type: String,
      default: '',
    },
    noSearchOrSearchDepartment: {
      type: Boolean,
      default: true,
    },
    statusMap: {
      type: Object,
      default: {},
    },
    timerMap: {
      type: Array,
      required: true,
    },
    isTableDataError: {
      type: Boolean,
      default: false,
    },
    isTableDataEmpty: {
      type: Boolean,
      default: false,
    },
  },
  data() {
    return {
      isAllChecked: false,
      dataList: [], // 展示的列表数据
      dataListPaged: [], // 将列表数据按 pageSize 分页
      throttle: false, // 滚动节流 是否进入cd
      isPageOver: false, // 前端分页加载是否结束
      count: null, // 数据总条数
      pageSize: null, // 每页展示多少数据
      totalPage: null, // 计算出总共多少页
      currentPage: null, // 当前加载了多少页
      pageLimit: 20, // 大于此条数前端分页
      lineHeight: 42, // 列表行高
      labelName: ['id', 'isCheck', 'departments', 'originItem'],
    };
  },
  computed: {
    activeTableHeardList() {
      const arr = ['id', 'isCheck', 'departments'];
      return this.userMessage.tableHeardList.filter(item => arr.indexOf(item.key) === -1);
    },
    enumInfo() {
      const enumInfo = {};
      const fieldsList = JSON.parse(JSON.stringify(this.fieldsList));
      fieldsList.forEach((fieldInfo) => {
        if (fieldInfo.type === 'one_enum') {
          enumInfo[fieldInfo.key] = {
            type: 'one_enum',
            options: fieldInfo.options,
          };
        } else if (fieldInfo.type === 'multi_enum') {
          enumInfo[fieldInfo.key] = {
            type: 'multi_enum',
            options: fieldInfo.options,
          };
        }
      });
      return enumInfo;
    },
  },
  watch: {
    'userMessage.userInforList'(value) {
      this.handleOriginList(value);
    },
    activeTableHeardList: {
      immediate: true,
      handler(value) {
        this.$emit('updateHeardList', value);
      },
    },
  },
  mounted() {
    if (this.userMessage.userInforList && this.userMessage.userInforList.length) {
      this.handleOriginList(this.userMessage.userInforList);
    }
  },
  methods: {
    handleOriginList(value) {
      this.$emit('updateTableData', value);
      if (this.isAllChecked) {
        this.isAllChecked = false;
      }
      this.$refs.scrollWrapper.scrollTo({ top: 0 });

      if (value.length > this.pageLimit) {
        this.dataList = [];
        this.initPageConf(value);
        this.loadPage();
      } else {
        this.dataList = value;
        this.isPageOver = true;
      }
    },
    initPageConf(list) {
      this.currentPage = 0;
      this.isPageOver = false;

      this.count = list.length;
      this.pageSize = Math.ceil(this.$refs.scrollWrapper.offsetHeight / this.lineHeight);
      this.totalPage = Math.ceil(this.count / this.pageSize) || 1;

      this.dataListShadow = [...list];
      this.dataListPaged = [];
      for (let i = 0; i < this.count; i += this.pageSize) {
        this.dataListPaged.push(this.dataListShadow.slice(i, i + this.pageSize));
      }
    },
    loadPage() {
      this.currentPage += 1;
      this.isPageOver = this.currentPage === this.totalPage;
      this.dataList.splice(this.dataList.length, 0, ...this.dataListPaged[this.currentPage - 1]);
    },
    handleTableScroll(e) {
      if (this.isPageOver || this.throttle) {
        return;
      }

      this.throttle = true;
      setTimeout(() => {
        this.throttle = false;
        if (e.target.scrollHeight - e.target.offsetHeight - e.target.scrollTop < 10) {
          this.loadPage();
        }
      }, 200);
    },
    departmentShift(departList) {
      let result = '';
      departList.forEach((item) => {
        const itemArr = item.split('/');
        result += `${itemArr[itemArr.length - 1]}/`;
      });
      return result.slice(0, result.length - 1).split('/')
        .join(';');
    },
    getLeaderString(leader) {
      return leader && leader.map((item) => {
        return item.username;
      }).join(';');
    },
    getValueByType(key, value) {
      if (this.enumInfo[key]) {
        // 枚举值
        const options = this.enumInfo[key].options;
        if (this.enumInfo[key].type === 'one_enum') {
          // 单选 value 期望是数值或字符串
          if (typeof value !== 'number' && typeof value !== 'string') {
            console.warn(`${key} ${this.$t('字段的值应该是数值或字符串')}（options.id）`);
            return '';
          }
          for (let i = 0; i < options.length; i++) {
            if (options[i].id === value || options[i].id === Number(value)) {
              if (this.$i18n.locale === 'en') {
                return value;
              }
              return this.statusMap[key][value];
            }
          }
        } else {
          // 多选 value 期望是数组
          if (!Array.isArray(value)) {
            console.warn(`${key} ${this.$t('字段的值应该是数组')}`);
            return '';
          }
          const results = [];
          value.forEach((item) => {
            for (let i = 0; i < options.length; i++) {
              if (options[i].id === item) {
                results.push(options[i].value);
                break;
              }
            }
          });
          return results.join(';');
        }
      } else {
        if (this.timerMap.includes(key)) {
          return dateConvert(value);
        }
        return value;
      }
    },
    // 单选、多选
    selectItemInfor(item) {
      item.isCheck = !item.isCheck;
      this.isAllChecked = !this.userMessage.userInforList.some((element) => {
        return !element.isCheck;
      });
      const isClick = this.userMessage.userInforList.some((element) => {
        return element.isCheck;
      });
      this.$emit('update:isClick', isClick);
    },
    // 点击查看当前用户的信息： 1.调用接口，拿到当前用户的信息 成功后抛给父组件
    viewDetails(item) {
      this.$emit('viewDetails', item.originItem);
    },
    // 全选
    selectAll() {
      this.isAllChecked = !this.isAllChecked;
      this.userMessage.userInforList.forEach((item) => {
        item.isCheck = this.isAllChecked;
      });
      this.$emit('update:isClick', this.isAllChecked);
    },
  },
};
</script>

<style lang="scss" scoped>
@import '../../../scss/mixins/scroller';

.table-list-wrapper {
  margin-bottom: 20px;
  height: calc(100% - 66px);
  border: 1px solid #dcdee5;

  > .table-container {
    // table 公用样式
    > table {
      width: 100%;
      table-layout: fixed;
      border: none;
      border-collapse: collapse;
      font-size: 12px;

      tr {
        height: 42px;
        border-bottom: 1px solid #dcdee5;
      }

      .king-checkbox {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 20px;
        margin-right: 0;
        padding: 0;

        input {
          margin: 0;
        }
      }
    }
  }

  > .thead-container {
    height: 42px;

    > table {
      background: #fafbfd;

      th {
        padding: 0 10px;
        text-align: left;
        border: none;
        cursor: text;
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        // checkbox
        &.checkbox-table-item {
          width: 60px;
          text-align: center;
        }

        &.hidden {
          display: none;
        }

        > span {
          font-size: 12px;
          height: 20px;
          line-height: 20px;
        }
      }
    }
  }

  > .tbody-container {
    height: calc(100% - 42px);
    overflow: hidden auto;

    @include scroller($backgroundColor: #e6e9ea, $width: 4px);

    > table > tbody > tr {
      cursor: pointer;
      transition: all .3s ease;

      &:hover {
        background: #e1ecff;
      }

      > td {
        padding: 0 10px;
        border: none;
        // checkbox
        &.checkbox-table-item {
          width: 60px;
          text-align: center;
        }

        &.hidden {
          display: none;
        }

        > .list-wrapper {
          width: 100%;

          span {
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          }
        }

        > div {
          height: 20px;
          line-height: 20px;
        }

        .king-tooltips {
          .staff-text {
            width: 100%;
            outline: none;
            display: inline-block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          }
        }
      }
    }
  }
}
</style>
